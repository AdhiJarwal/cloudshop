name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to promote'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  Promote_To_Production:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform apply
        run: |
          cd infra/envs/prod
          terraform init
          terraform apply -auto-approve \
            -var="backend_image_tag=${{ inputs.image_tag }}" \
            -var="active_color=blue" \
            -var="db_password=${{ secrets.PROD_DB_PASSWORD }}"

      - name: Force new deployment
        run: |
          CLUSTER=$(terraform -chdir=infra/envs/prod output -raw cluster_name)
          aws ecs update-service --cluster $CLUSTER --service prod-backend-blue --force-new-deployment

      - name: Wait for service to be stable
        run: |
          CLUSTER=$(terraform -chdir=infra/envs/prod output -raw cluster_name)
          aws ecs wait services-stable --cluster $CLUSTER --services prod-backend-blue

      - name: Run smoke tests
        run: |
          ALB_DNS=$(terraform -chdir=infra/envs/prod output -raw alb_dns_name)
          bash scripts/smoke-test-api.sh http://$ALB_DNS

      - name: Deployment summary
        run: |
          echo "Promoted to production with image tag: ${{ inputs.image_tag }}"
          echo "Service: prod-backend-blue"
