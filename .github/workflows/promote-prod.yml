name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to promote'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  Promote_To_Production:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Get current active color
        id: active-color
        run: |
          ACTIVE=$(aws ssm get-parameter --name /prod/backend/active_color --query 'Parameter.Value' --output text 2>/dev/null || echo "blue")
          echo "current=$ACTIVE" >> $GITHUB_OUTPUT
          if [ "$ACTIVE" = "blue" ]; then
            echo "inactive=green" >> $GITHUB_OUTPUT
          else
            echo "inactive=blue" >> $GITHUB_OUTPUT
          fi

      - name: Terraform apply
        run: |
          cd infra/envs/prod
          terraform init
          terraform apply -auto-approve \
            -var="backend_image_tag=${{ inputs.image_tag }}" \
            -var="active_color=${{ steps.active-color.outputs.current }}" \
            -var="db_password=${{ secrets.PROD_DB_PASSWORD }}"

      - name: Wait for inactive service
        run: |
          CLUSTER=$(terraform -chdir=infra/envs/prod output -raw cluster_name)
          SERVICE=${{ steps.active-color.outputs.inactive }}
          aws ecs wait services-stable --cluster $CLUSTER --services prod-backend-$SERVICE

      - name: Run smoke tests
        run: |
          ALB_DNS=$(terraform -chdir=infra/envs/prod output -raw alb_dns_name)
          bash scripts/smoke-test-api.sh http://$ALB_DNS

      - name: Switch traffic to new version
        if: success()
        run: |
          cd infra/envs/prod
          terraform apply -auto-approve \
            -var="backend_image_tag=${{ inputs.image_tag }}" \
            -var="active_color=${{ steps.active-color.outputs.inactive }}" \
            -var="db_password=${{ secrets.PROD_DB_PASSWORD }}"
          
          aws ssm put-parameter \
            --name /prod/backend/active_color \
            --value "${{ steps.active-color.outputs.inactive }}" \
            --overwrite

      - name: Deployment summary
        run: |
          echo "Promoted to production with image tag: ${{ inputs.image_tag }}"
          echo "Active color: ${{ steps.active-color.outputs.inactive }}"
